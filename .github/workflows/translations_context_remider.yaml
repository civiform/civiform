# Source - https://stackoverflow.com/a/61565445
# Posted by Michael Parker, modified by community. See post 'Timeline' for change history
# Retrieved 2026-02-04, License - CC BY-SA 4.0

name: Translations Context Reminder

on:
  pull_request:
    types:
      - closed

jobs:
  notify_on_messages_change:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Check if messages file was modified
        id: check_messages
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            // GitHub username -> Slack user ID mapping
            const slackUserMap = {
              'tallulahkay': 'U08ELT9CAB0',
              'fernandez-jack': 'U09HKV8L57V',
              'melanie-exygy': 'U057V0H2K0W'
            };

            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const messagesModified = files.data.some(file => file.filename === 'server/conf/i18n/messages');
            core.setOutput('modified', messagesModified);

            const ghUser = context.payload.pull_request.user.login;
            const slackUserId = slackUserMap[ghUser];
            const mention = slackUserId ? `<@${slackUserId}>` : '';
            core.setOutput('mention', mention);

      - name: Send Slack notification
        if: steps.check_messages.outputs.modified == 'true' && steps.check_messages.outputs.mention != ''
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "Translations update needed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.check_messages.outputs.mention }}: *Reminder to update translations in Transifex for this PR:*\n<${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>\n\nThe base messages file was modified. Please:\n1. Add context for any new or updated strings in <https://app.transifex.com/civiform/|Transifex> (add the context string under 'String Instructions')\n2. If you don't want strings to be translated yet, mark them as locked by typing \"locked\" in the Tags field\n\nSee the <https://github.com/civiform/civiform/wiki/Internationalization-(i18n)#adding-new-strings|wiki> for full instructions."
                  }
                }
              ]
            }

