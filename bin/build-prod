#! /usr/bin/env bash

# DOC: Build a new production docker image, tagged with short commit SHA and unix seconds timestamp, and optionally push to Docker Hub if PUSH_IMAGE is set to anything.

source bin/lib.sh

export DOCKER_BUILDKIT=1
readonly SHORT_SHA="$(git rev-parse --short HEAD)"
readonly GIT_SHA="$(git rev-parse HEAD)"
readonly DATE_IN_UNIX_SECONDS="$(date +%s)"
readonly SNAPSHOT_TAG="SNAPSHOT-${SHORT_SHA}-${DATE_IN_UNIX_SECONDS}"

echo "Building ${SNAPSHOT_TAG}..."

PLATFORM="${PLATFORM:-"linux/amd64"}"

docker buildx build --platform="${PLATFORM}" \
  -f prod.Dockerfile \
  -t civiform:latest \
  --cache-from civiform/civiform:latest \
  --build-arg BUILDKIT_INLINE_CACHE=1 \
  --build-arg "git_commit_sha=${GIT_SHA}" \
  --build-arg "image_tag=${SNAPSHOT_TAG}" \
  .

if [[ "${PUSH_IMAGE}" ]]; then
  docker::do_dockerhub_login

  docker tag civiform:latest civiform/civiform:latest
  docker tag civiform:latest "civiform/civiform:${SNAPSHOT_TAG}"

  # push the new image to the Docker Hub registry
  docker push --all-tags civiform/civiform
fi
