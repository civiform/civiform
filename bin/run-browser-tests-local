#! /usr/bin/env bash

# DOC: Run the browser tests locally. Requires browser test env already running.

source bin/lib.sh
export BASE_URL="https://staging-mikita.civiform.dev"
export DISABLE_SCREENSHOTS=true
export TEST_USER_AUTH_STRATEGY=fake-oidc
export TEST_USER_LOGIN=testuser
export TEST_USER_PASSWORD=anotsecretpassword
# The display name returned by test_oidc_provider.js is <username>@example.com.
export TEST_USER_DISPLAY_NAME=testuser@example.com

START_TIME=$(date +%s)
DEADLINE=$(($START_TIME + 500))

if ! output="$(node -v)"; then
  echo output
  echo "You must have node installed locally to run this command. Go to https://nodejs.org/en/download/package-manager/ for installation instructions."
  exit 1
fi

cd browser-test
npm install --force --quiet

echo "Polling to check server start"

until $(curl --output /dev/null --silent --head --fail --max-time 2 "${BASE_URL}"); do
  if (($(date +%s) > "${DEADLINE}")); then
    echo "Deadline exceeded waiting for server start"
    exit 1
  fi
done

echo "Detected server start"

# If test fails - don't abort script. Allow eslint below to run in case it can
# provide useful findings about code.
npm test "$@" || true

echo -e "\nRunning eslint..."
npx eslint --cache "src/**/*.ts"
echo "Done!"
