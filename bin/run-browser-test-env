#!/bin/bash

# DOC: Run the app locally using Docker for use with running browser tests.

pushd $(git rev-parse --show-toplevel)

set -e

bin/pull-image

if [ -f ".secrets" ]; then
  . .secrets
fi

# Get cloud provider
_setArgs(){
  while [ "${1:-}" != "" ]; do
    case "$1" in
      "--azure")
       cloudProvider="azure"
       emulator="azurite"
       devServer="http://localhost:10000"
       export STORAGE_SERVICE_NAME="azure-blob"
       ;;
      "--aws")
       cloudProvider="aws"
       emulator="localstack"
       devServer="http://localhost:6645"
       export STORAGE_SERVICE_NAME="s3"
       ;;
    esac
    shift
  done
}

_setArgs "$@"

# default to AWS for now
if [ -z "$cloudProvider" ]; then
  cloudProvider="aws" && emulator="localstack" && devServer="http://localhost:6645"
  export STORAGE_SERVICE_NAME="s3"
fi

# start emulator
docker-compose --profile $cloudProvider \
  -f browser-test/browser-test-compose.yml \
  -f browser-test/browser-test-compose.dev.yml \
  up -d $emulator

# wait until emulator running
bin/$emulator/wait $devServer

# start everything else
docker-compose -f browser-test/browser-test-compose.yml -f browser-test/browser-test-compose.dev.yml up

popd
