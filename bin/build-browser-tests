#! /bin/bash

# DOC: Build a new docker image for running the browser tests and push to Docker hub

pushd $(git rev-parse --show-toplevel)

set -e
set +x

docker build -t civiform-browser-test:latest \
  browser-test \
  -f browser-test/playwright.Dockerfile \
  --cache-from civiform/civiform-browser-test:latest \
  --build-arg BUILDKIT_INLINE_CACHE=1

if [ "$PUSH_BROWSER_TEST_IMAGE" ]; then
  # log the docker CLI into the Docker Hub container registry
  echo $DOCKER_HUB_ACCESS_TOKEN | docker login --username $DOCKER_HUB_USERNAME --password-stdin docker.io

  # push the new image to the Docker Hub registry
  docker tag civiform-browser-test:latest docker.io/civiform/civiform-browser-test:latest
  docker push docker.io/civiform/civiform-browser-test:latest
fi

popd
