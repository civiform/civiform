#! /bin/bash

# DOC: Build a new development docker image and push it to the AWS and Docker Hub container registries.

set -e
set +x
export AWS_DEFAULT_REGION=us-west-2
REGION=us-west-2

# log the docker CLI into the AWS container registry
aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/t1q6b4h2

# build the new image based
docker build -t civiform-dev --cache-from docker.io/civiform/civiform-browser-test:latest --build-arg BUILDKIT_INLINE_CACHE=1 .

# push the new image to the AWS registry
docker tag civiform-dev:latest public.ecr.aws/t1q6b4h2/civiform-dev:latest
docker push public.ecr.aws/t1q6b4h2/civiform-dev:latest

# clear AWS login state
docker logout public.ecr.aws/t1q6b4h2

# log the docker CLI into the Docker Hub container registry
echo $DOCKER_HUB_ACCESS_TOKEN | docker login --username $DOCKER_HUB_USERNAME --password-stdin docker.io

# push the new image to the Docker Hub registry
docker tag civiform-dev:latest civiform/civiform-dev:latest
docker push docker.io/civiform/civiform-dev:latest
