#! /usr/bin/env bash

# DOC: Build a new development docker image and optionally push to Docker Hub if PUSH_IMAGE is set to anything.

source bin/lib.sh
export DOCKER_BUILDKIT=1

PLATFORM="${PLATFORM:-"linux/amd64"}" # default to x86-64 when platform not specified

# Build the new development image.
docker buildx build --load --platform="${PLATFORM}" \
  -t civiform-dev:latest \
  --cache-from civiform/civiform-dev:latest \
  --build-arg BUILDKIT_INLINE_CACHE=1 \
  .

if [[ "${PUSH_IMAGE}" ]]; then
  docker::do_dockerhub_login

  docker tag civiform-dev:latest civiform/civiform-dev:latest

  # Push the new image to the Docker Hub registry.
  docker push docker.io/civiform/civiform-dev:latest
fi
