#! /bin/bash

# DOC: Build a new production docker image, push to Docker Hub tagged with short commit SHA and unix seconds timestamp.

pushd $(git rev-parse --show-toplevel)

set -e
set +x

short_sha=$(git rev-parse --short HEAD)
date_in_unix_seconds=$(date +%s)
snapshot_tag="SNAPSHOT-${short_sha}-${date_in_unix_seconds}"

echo "Building ${snapshot_tag}..."

docker build -f prod.Dockerfile \
  -t civiform:latest \
  --cache-from civiform/civiform:latest \
  --build-arg BUILDKIT_INLINE_CACHE=1 .

# log the docker CLI into the Docker Hub container registry
echo $DOCKER_HUB_ACCESS_TOKEN | docker login --username $DOCKER_HUB_USERNAME --password-stdin docker.io

docker tag civiform:latest civiform/civiform:latest
docker tag civiform:latest "civiform/civiform:${snapshot_tag}"

# push the new image to the Docker Hub registry
docker push --all-tags civiform/civiform

popd
