#! /usr/bin/env bash

# DOC: Pulls the latest development environment docker image from Docker Hub unless USE_LOCAL_CIVIFORM=1 is set.
# Use 'PULL_PROGERSS=1' to show docker image download progress.
# Use 'USE_LOCAL_CIVIFORM=1' to use locally cached docker image instead of downloading.

source bin/lib.sh

readonly CIVIFORM_SOURCE=civiform/civiform-dev:latest
readonly OIDC_SOURCE=docker.io/civiform/oidc-provider:latest
readonly AZURE_SOURCE=mcr.microsoft.com/azure-storage/azurite
readonly AWS_SOURCE=localstack/localstack
readonly LOCAL_TAG=civiform-dev

echo "Making sure we're up to date with the latest dev"
if [[ -z "${USE_LOCAL_CIVIFORM}" ]]; then
  echo "Set environment variable USE_LOCAL_CIVIFORM=1 to skip"
  if [[ -z "${PULL_PROGRESS}" ]]; then
    echo "Set environment variable PULL_PROGRESS=1 to show download progress"
    docker pull "${CIVIFORM_SOURCE}"
    docker tag "${CIVIFORM_SOURCE}" "${LOCAL_TAG}"

    # Explicitly pull dev dependencies.
    docker pull "${OIDC_SOURCE}"
    docker pull "${AZURE_SOURCE}"
    docker pull "${AWS_SOURCE}"
  else
    echo "Using local civiform and dependency docker images"
    docker pull -q "${CIVIFORM_SOURCE}"
    docker tag "${CIVIFORM_SOURCE}" "${LOCAL_TAG}"

    # Explicitly pull dev dependencies.
    docker pull -q "${OIDC_SOURCE}"
    docker pull -q "${AZURE_SOURCE}"
    docker pull -q "${AWS_SOURCE}"
  fi
else
  echo "Using local civiform docker images"
fi
